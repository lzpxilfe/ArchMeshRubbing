# ArchMeshRubbing

고고학 유물의 3D 스캔 메쉬를 평면으로 펼쳐 탁본과 유사한 이미지를 생성하는 도구입니다.

## 주요 기능

- **메쉬 평면화**: ARAP 알고리즘으로 곡면을 왜곡 최소화하며 펼침
- **정사투영**: 3D 메쉬의 평면도 생성
- **표면 분리**: 내면/외면 자동 감지 + 사용자 지정(면 선택/할당)
- **프로젝트(.amr) 저장/불러오기**: 변환/단면/ROI/레이어/내보내기 옵션까지 함께 저장
- **통합 SVG 출력**: 실측(Top 외곽선) + 단면 + 내/외면 탁본을 1회 SVG로 저장
- **영역 선택**: 미구 등 특정 부분만 추출 (점-올가미/경계(자석) 올가미)
- **스케일 출력**: 실측 스케일이 맞춰진 이미지 내보내기

## 설치

```bash
pip install -r requirements.txt
pip install -r requirements-optional.txt  # optional
```

## 실행

### GUI (추천)

```bash
python app_interactive.py
```

또는:

```bash
python main.py --gui
python main.py --open-project my_project.amr
```

#### 프로젝트 저장/불러오기 (.amr)

- 메뉴 **파일 → 프로젝트 저장 / 프로젝트 열기** (단축키: `Ctrl+S`, `Ctrl+Shift+O`)
- 단면/가이드(레이어)까지 함께 저장하려면 **단면 도구**에서 **레이어로 저장**을 눌러 스냅샷을 남겨두세요.

### CLI

```bash
python main.py --help
```

## 2D 실측 도면(SVG) 내보내기

- GUI의 **내보내기 → 2D 실측 도면 내보내기(SVG)**에서 뷰별로 저장하거나, **📦 6방향 패키지 내보내기**로 한 폴더에 일괄 저장할 수 있습니다.
- 기본은 **격자/배경 포함(1cm 격자 + 화면 캡처)**이며, 체크 해제 시 **벡터만(SVG)** 저장합니다.

## 통합 SVG(실측+단면+내/외면 탁본) 내보내기

한 번의 SVG 내보내기로 아래를 한 시트에 함께 저장합니다.

- **Top 외곽선 실측(벡터)** + (선택) **단면선/단면 폴리라인(벡터)**
- **외면 탁본(이미지)** / **내면 탁본(이미지)** *(SVG 안에 PNG로 포함)*

권장 워크플로우:

1) (권장) **메쉬 정렬**: 바닥면 정렬(3점/면/브러시) 기능으로 “위/아래(Z-up)”가 맞게 정렬  
2) **내/외면 지정** (자동이 이상하면 꼭 필요)  
   - 우측 **펼침** 패널 → “표면 선택/지정”에서 **대상(외면/내면/미구)** 선택  
   - “찍기(자동 확장)”으로 표면을 클릭해 지정 *(Shift/Ctrl=추가, Alt=제거, ESC=종료)*  
   - “보정(브러시)”로 드래그 칠하기/지우기 *(Alt=지우기)*  
   - “면적(Area)”로 **메쉬 위에 점을 찍어** 다각형을 만들고 보이는 면을 한 번에 지정 *(시작점 근처 클릭=스냅 닫힘(자동 확정), 좌클릭=점 추가(드래그=회전), 우클릭/Enter=확정(우클릭 위치가 완드 기준), Backspace=되돌리기, Alt=제거)*  
   - “경계(자석)”으로 **드래그로 그린 자유곡선**을 메쉬 윤곽/경계에 “붙여가며” 영역 지정 *(드래그=그리기, 우클릭/Enter=확정, Backspace=되돌리기, Shift/Ctrl=완드 정제, Alt=제거, `[ / ]`=자석 반경)*  
   - (옵션) “자동 분리(실험)”은 메쉬/정렬 상태에 따라 실패할 수 있어 보조용입니다  
3) (옵션) **단면선 입력**: 우측 단면 패널에서 단면선/ROI를 잡아두면 통합 SVG에 함께 포함됩니다  
4) **내보내기**: 우측 내보내기 패널 → “통합 SVG (실측+단면+내/외면 탁본)”

참고:
- “미구 전개/펼침”은 아직 후순위(미구 지정은 저장만 됨)입니다.
- 내/외면을 지정하지 않으면 자동 분리(법선 기준)로 fallback 됩니다.

## 탁본 이미지(PNG/TIFF) 내보내기

- 우측 **내보내기** 패널에서 **탁본 대상(전체/외면/내면/미구)** 을 선택할 수 있습니다.
- 외면/내면/미구는 “표면 선택/지정” 결과(face set)를 사용합니다. 비어 있으면 먼저 지정해 주세요.
- 기와처럼 원통(와통) 곡률이 뚜렷하면 **디지털 탁본(곡률 제거)** 을 권장합니다. (원통 펼침 + 곡률 제거 프리셋)

## 단축키

- `[` / `]`: (상황별) 표면 도구 크기/자석 반경/회전 기즈모 크기 조절
- `Space` + 드래그: 표면 도구 사용 중 시점 이동(회전)
- `F`: 선택 객체 화면 맞춤
- `R`: 카메라 리셋

## Git / 백업 주의

- 대용량/작업 파일(`*.stl`, `*.amr`, `*.obj`, `*.ply`, `*.off`)과 로컬 연구 자료(`__carrotphant_*` 등)는 **커밋하지 않도록** `.gitignore`로 제외합니다.
- Push 전에 항상 `git status`로 스테이징 목록을 확인하세요.

## 단면 슬라이싱 프리셋 (Clip Presets)

- **📏 단면 슬라이싱(CT)** 패널에서 현재 높이(Z)를 **프리셋으로 저장/적용/삭제**할 수 있습니다.
- 원하는 높이에서 단면을 만든 뒤 **레이어로 저장**을 눌러 스냅샷을 남기면, 이후 **통합 SVG** 또는 **2D 실측 도면(SVG)** 내보내기에 함께 포함됩니다.

## 환경 변수 (트러블슈팅)

- `ARCHMESHRUBBING_PROFILE_EXPORT_SAFE=1`: SVG 외곽선/가이드 투영을 보수적으로 처리 (Illustrator에서 `격자 + 긴 직선`만 보일 때 권장)
- `ARCHMESHRUBBING_DISABLE_OPENCV=1`: OpenCV 비활성화 (SciPy 기반 경로 사용)
- `ARCHMESHRUBBING_CV2_IMPORT_TIMEOUT=2.0`: OpenCV import smoke-test 타임아웃(초)
- `ARCHMESHRUBBING_LOG_LEVEL=DEBUG`: 디버그 로그 활성화 (Windows 기본 로그 경로: `%LOCALAPPDATA%\\ArchMeshRubbing\\logs\\archmeshrubbing.log`)

## 지원 포맷

- OBJ (Wavefront)
- PLY (Polygon File Format)
- STL (Stereolithography)
- OFF (Object File Format)

## References

- 구현에 사용된 주요 알고리즘/기법의 공개 레퍼런스: `docs/REFERENCES.md`

## 라이선스

GNU General Public License v2.0 (GPLv2) — 자세한 내용은 `LICENSE` 파일을 참고하세요.
